{% extends 'base.html' %}

{% block title %}Formulário de Troca de Gelo - 5S{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="trocaGeloForm()">
    <!-- Card Principal -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <!-- Título -->
        <div class="mb-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <i class="fas fa-clipboard-check text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800">Formulário de Troca de Gelo</h2>
            <p class="text-gray-600 mt-2">Preencha todos os passos para registrar a troca</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Progresso</span>
                <span class="text-sm font-medium text-gray-700" x-text="progressPercentage + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 relative overflow-visible mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500 ease-out shadow-sm" 
                     :style="'width: ' + progressPercentage + '%'"></div>
            </div>
            
            <!-- Indicadores de Passos -->
            <div class="grid grid-cols-6 gap-2 text-xs">
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasModelo ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasModelo ? 'fas fa-check' : 'fas fa-box'"></i>
                    </div>
                    <span class="text-gray-600">Modelo</span>
                </div>
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasPedido ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasPedido ? 'fas fa-check' : 'fas fa-hashtag'"></i>
                    </div>
                    <span class="text-gray-600">Pedido</span>
                </div>
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasData ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasData ? 'fas fa-check' : 'fas fa-calendar'"></i>
                    </div>
                    <span class="text-gray-600">Data</span>
                </div>
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasFotoEtiqueta ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasFotoEtiqueta ? 'fas fa-check' : 'fas fa-tag'"></i>
                    </div>
                    <span class="text-gray-600">Etiqueta</span>
                </div>
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasFotoTempMed && hasTempMed ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasFotoTempMed && hasTempMed ? 'fas fa-check' : 'fas fa-thermometer-half'"></i>
                    </div>
                    <span class="text-gray-600">Temp Med</span>
                </div>
                <div class="text-center">
                    <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 transition-all duration-300"
                         :class="hasFotoTempGelo && hasTempGelo ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'">
                        <i :class="hasFotoTempGelo && hasTempGelo ? 'fas fa-check' : 'fas fa-snowflake'"></i>
                    </div>
                    <span class="text-gray-600">Temp Gelo</span>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <form method="post" enctype="multipart/form-data" id="trocaGeloForm">
            {% csrf_token %}

            <!-- Passo 01: Modelo da Caixa -->
            <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-full font-bold mr-3">
                        1
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Modelo da Caixa</h3>
                </div>
                
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">
                        {{ form.modelo_caixa.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.modelo_caixa }}
                    
                    <!-- Info dinâmica baseada no modelo -->
                    <div x-show="selectedModel" class="mt-3 p-4 bg-white rounded-lg border border-blue-200">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <strong>Faixa de temperatura do medicamento:</strong>
                            <span x-text="tempRangeMedicamento"></span>
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <i class="fas fa-snowflake text-blue-600 mr-2"></i>
                            <strong>Faixa de temperatura do gelo:</strong>
                            <span>-5,0°C até -9,0°C</span>
                        </p>
                    </div>
                    
                    {% if form.modelo_caixa.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.modelo_caixa.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 02: Número do Pedido -->
            <div class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-purple-600 text-white rounded-full font-bold mr-3">
                        2
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Número do Pedido</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.numero_pedido.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.numero_pedido }}
                    
                    {% if form.numero_pedido.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.numero_pedido.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 03: Data da Embalagem -->
            <div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl border-2 border-green-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full font-bold mr-3">
                        3
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Data da Embalagem</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.data_embalagem.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.data_embalagem }}
                    
                    {% if form.data_embalagem.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.data_embalagem.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 04: Foto da Etiqueta -->
            <div class="mb-8 p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border-2 border-yellow-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-yellow-600 text-white rounded-full font-bold mr-3">
                        4
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Foto da Etiqueta</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.foto_etiqueta.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.foto_etiqueta }}
                    
                    <div x-show="previewEtiqueta" class="mt-4">
                        <img :src="previewEtiqueta" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                    </div>
                    
                    {% if form.foto_etiqueta.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.foto_etiqueta.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 05: Temperatura do Medicamento -->
            <div class="mb-8 p-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border-2 border-red-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-red-600 text-white rounded-full font-bold mr-3">
                        5
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Temperatura do Medicamento</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Alerta de faixa de temperatura -->
                    <div class="p-4 bg-white rounded-lg border-2 border-red-300">
                        <p class="text-sm font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-thermometer-half text-red-600 mr-2"></i>
                            Faixa obrigatória:
                            <span class="ml-2 text-red-600" x-text="tempRangeMedicamento"></span>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.foto_temperatura_medicamento.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.foto_temperatura_medicamento }}
                        
                        <div x-show="previewTempMedicamento" class="mt-4">
                            <img :src="previewTempMedicamento" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                        </div>
                        
                        {% if form.foto_temperatura_medicamento.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.foto_temperatura_medicamento.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.temperatura_medicamento.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="number" 
                                step="0.1"
                                name="temperatura_medicamento" 
                                id="id_temperatura_medicamento"
                                placeholder="Ex: 5.5"
                                class="block w-full rounded-lg shadow-sm focus:border-black focus:ring-black py-3 pl-4 pr-10 font-light text-base"
                                required
                            >

                            <div class="absolute right-3 inset-y-0 flex items-center pointer-events-none">
                                <span class="text-gray-400 font-semibold">°C</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">{{ form.temperatura_medicamento.help_text }}</p>
                        
                        <!-- Validação visual em tempo real -->
                        <div x-show="tempMedicamento !== null && tempMedicamento !== ''" class="mt-2">
                            <div x-show="isValidTempMedicamento" class="text-green-600 text-sm flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                Temperatura dentro da faixa permitida
                            </div>
                            <div x-show="!isValidTempMedicamento" class="text-red-600 text-sm flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Temperatura fora da faixa permitida!
                            </div>
                        </div>
                        
                        {% if form.temperatura_medicamento.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.temperatura_medicamento.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Passo 06: Temperatura do Gelo -->
            <div class="mb-8 p-6 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border-2 border-cyan-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-cyan-600 text-white rounded-full font-bold mr-3">
                        6
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Temperatura do Gelo</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Alerta de faixa de temperatura -->
                    <div class="p-4 bg-white rounded-lg border-2 border-cyan-300">
                        <p class="text-sm font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-snowflake text-cyan-600 mr-2"></i>
                            Faixa obrigatória:
                            <span class="ml-2 text-cyan-600">-5,0°C até -9,0°C</span>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.foto_temperatura_gelo.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.foto_temperatura_gelo }}
                        
                        <div x-show="previewTempGelo" class="mt-4">
                            <img :src="previewTempGelo" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                        </div>
                        
                        {% if form.foto_temperatura_gelo.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.foto_temperatura_gelo.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Temperatura do Gelo (°C)
                            <span class="text-red-500">*</span>
                        </label>
                        
                        <!-- Input customizado com sinal negativo fixo e destacado -->
                        <div class="relative flex items-center group">
                            <!-- Sinal negativo fixo e destacado -->
                            <div class="absolute left-0 inset-y-0 flex items-center justify-center w-12 bg-gray-100 rounded-l-lg pointer-events-none z-10 border border-gray border-r-0 group-focus-within:border-black">
                                <span class="text-2xl font-bold text-red-600">−</span>
                            </div>
                            
                            <!-- Campo de input - máximo 3 caracteres -->
                            <input 
                                type="text" 
                                name="temperatura_gelo_display"
                                id="temperatura_gelo_display"
                                x-model="tempGeloPositivo"
                                @input="updateTempGelo()"
                                @keydown="validateKeyDown($event)"
                                @paste="handlePaste($event)"
                                inputmode="decimal"
                                maxlength="3"
                                placeholder="Ex: 5.5"
                                class="block w-full rounded-lg shadow-sm focus:border-black focus:ring-black text-base py-3 pl-14 pr-14 font-light text-base"
                                required
                                autocomplete="off"
                            />
                            
                            <!-- Campo hidden real que será enviado ao Django -->
                            <input type="hidden" name="temperatura_gelo" id="temperatura_gelo" x-model="tempGeloReal">
                            
                            <!-- Indicador de graus Celsius -->
                            <div class="absolute right-3 inset-y-0 flex items-center pointer-events-none">
                                <span class="text-gray-400 font-semibold">°C</span>
                            </div>
                        </div>
                        
                        <!-- Informações e instruções -->
                        <div class="mt-2 space-y-1">
                            <p class="text-xs text-blue-600 flex items-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Digite apenas de 5.0 até 9.0. (O sinal negativo já está fixo).</strong> 
                            </p>
                            
                            <p class="text-xs text-red-600 font-semibold">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Valores abaixo de 5.0 ou acima de 9.0 serão bloqueados!
                            </p>
                        </div>
                        
                        <!-- Preview do valor que será enviado -->
                        <div x-show="tempGeloPositivo && tempGeloPositivo !== ''" class="mt-3 p-3 bg-cyan-50 border border-cyan-200 rounded-lg">
                            <p class="text-sm text-cyan-800 flex items-center">
                                <i class="fas fa-arrow-right mr-2"></i>
                                <strong>Valor que será registrado:</strong>
                                <span class="ml-2 text-lg font-bold text-cyan-600" x-text="tempGeloReal ? tempGeloReal + '°C' : 'Digite um valor válido'"></span>
                            </p>
                        </div>
                        
                        <!-- Validação visual em tempo real -->
                        <div x-show="tempGelo !== null && tempGelo !== ''" class="mt-2">
                            <div x-show="isValidTempGelo" class="text-green-600 text-sm flex items-center bg-green-50 p-2 rounded-lg">
                                <i class="fas fa-check-circle mr-2 text-lg"></i>
                                <strong>Temperatura dentro da faixa permitida!</strong>
                            </div>
                            <div x-show="!isValidTempGelo" class="text-red-600 text-sm flex items-center bg-red-50 p-2 rounded-lg">
                                <i class="fas fa-exclamation-circle mr-2 text-lg"></i>
                                <strong>❌ Atenção! Valor deve estar entre 5.0 e 9.0</strong>
                            </div>
                        </div>
                        
                        <!-- Mensagem de erro se tentar digitar fora do range -->
                        <div x-show="showRangeError" x-transition class="mt-2 text-red-600 text-sm flex items-center bg-red-50 p-2 rounded-lg border border-red-300">
                            <i class="fas fa-ban mr-2 text-lg"></i>
                            <strong x-text="rangeErrorMessage"></strong>
                        </div>
                        
                        {% if form.temperatura_gelo.errors %}
                        <div class="text-red-600 text-sm mt-2 bg-red-50 p-2 rounded-lg border border-red-200">
                            <i class="fas fa-times-circle mr-1"></i>
                            {{ form.temperatura_gelo.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Informação de Ambientação -->
            <div class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <div class="flex items-center mb-3">
                    <i class="fas fa-clock text-indigo-600 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Período de Ambientação</h3>
                </div>
                <p class="text-sm text-gray-700">
                    Ao finalizar a última foto do gelo, o sistema registrará automaticamente:
                </p>
                <ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">
                    <li>Horário de finalização: momento do envio</li>
                    <li>Início da ambientação: 20 minutos antes da finalização</li>
                </ul>
                <div class="mt-3 p-3 bg-white rounded-lg border border-indigo-300">
                    <p class="text-xs text-gray-600">
                        <strong>Exemplo:</strong> Se você finalizar às 17:59, o período de ambientação será registrado de 17:39 até 17:59
                    </p>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Finalizar e Registrar Troca
                </button>
                
                <button type="reset" 
                        class="flex-1 bg-gray-200 text-gray-700 font-semibold py-4 px-6 rounded-xl hover:bg-gray-300 transition duration-300 flex items-center justify-center"
                        onclick="return confirm('Tem certeza que deseja limpar o formulário?')">
                    <i class="fas fa-redo mr-2"></i>
                    Limpar Formulário
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function trocaGeloForm() {
        return {
            selectedModel: '',
            tempMedicamento: null,
            tempGelo: null,
            tempGeloPositivo: '',
            tempGeloReal: '',
            previewEtiqueta: null,
            previewTempMedicamento: null,
            previewTempGelo: null,
            // Propriedades reativas para controlar o progresso
            hasModelo: false,
            hasPedido: false,
            hasData: false,
            hasFotoEtiqueta: false,
            hasFotoTempMed: false,
            hasTempMed: false,
            hasFotoTempGelo: false,
            hasTempGelo: false,
            showRangeError: false,
            rangeErrorMessage: '',
            
            // Valida teclas pressionadas
            validateKeyDown(event) {
                const key = event.key;
                const currentValue = this.tempGeloPositivo;
                
                // Permite teclas de controle
                if (['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(key)) {
                    return true;
                }
                
                // Permite apenas números e ponto
                if (!/^[0-9.]$/.test(key)) {
                    event.preventDefault();
                    return false;
                }
                
                // Permite apenas um ponto
                if (key === '.' && currentValue.includes('.')) {
                    event.preventDefault();
                    return false;
                }
                
                // Limita a 3 caracteres
                if (currentValue.length >= 3 && !['Backspace', 'Delete'].includes(key)) {
                    event.preventDefault();
                    return false;
                }
                
                // Validação do primeiro dígito (deve ser 5-9)
                if (currentValue.length === 0 && /^[0-9]$/.test(key)) {
                    const digit = parseInt(key);
                    if (digit < 5 || digit > 9) {
                        event.preventDefault();
                        this.showRangeError = true;
                        this.rangeErrorMessage = `Primeiro dígito deve ser entre 5 e 9. Você tentou: ${digit}`;
                        setTimeout(() => { this.showRangeError = false; }, 3000);
                        return false;
                    }
                }
                
                return true;
            },
            
            // Trata eventos de colar
            handlePaste(event) {
                event.preventDefault();
                const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                const cleaned = pastedText.replace(/[^0-9.]/g, '').substring(0, 3);
                
                if (cleaned) {
                    const valor = parseFloat(cleaned);
                    if (!isNaN(valor) && valor >= 5 && valor <= 9) {
                        this.tempGeloPositivo = cleaned;
                        this.updateTempGelo();
                    } else {
                        this.showRangeError = true;
                        this.rangeErrorMessage = 'Valor colado está fora da faixa permitida (5.0 a 9.0)';
                        setTimeout(() => { this.showRangeError = false; }, 3000);
                    }
                }
            },
            
            // Função para atualizar temperatura do gelo
            updateTempGelo() {
                if (this.tempGeloPositivo && this.tempGeloPositivo.trim() !== '') {
                    // Limita a 3 caracteres
                    if (this.tempGeloPositivo.length > 3) {
                        this.tempGeloPositivo = this.tempGeloPositivo.substring(0, 3);
                    }
                    
                    // Remove caracteres inválidos (mantém apenas números e um ponto)
                    let valor = this.tempGeloPositivo.replace(/[^0-9.]/g, '');
                    
                    // Garante apenas um ponto decimal
                    const partes = valor.split('.');
                    if (partes.length > 2) {
                        valor = partes[0] + '.' + partes[1];
                    }
                    
                    // Atualiza o valor limpo
                    this.tempGeloPositivo = valor;
                    
                    // Converte para número
                    let valorPositivo = parseFloat(valor);
                    
                    if (!isNaN(valorPositivo)) {
                        // Valida range 5-9 (SEM ajuste automático)
                        if (valorPositivo < 5 || valorPositivo > 9) {
                            this.tempGeloReal = '';
                            this.tempGelo = null;
                            this.hasTempGelo = false;
                            this.showRangeError = true;
                            this.rangeErrorMessage = `Valor ${valorPositivo} está fora da faixa! Digite entre 5.0 e 9.0`;
                            setTimeout(() => { this.showRangeError = false; }, 3000);
                            return;
                        }
                        
                        // Arredonda para 1 casa decimal
                        valorPositivo = Math.round(valorPositivo * 10) / 10;
                        
                        // Converte para negativo para o campo real
                        this.tempGeloReal = (-valorPositivo).toFixed(1);
                        this.tempGelo = -valorPositivo;
                        this.hasTempGelo = true;
                        this.showRangeError = false;
                    } else {
                        this.tempGeloReal = '';
                        this.tempGelo = null;
                        this.hasTempGelo = false;
                    }
                } else {
                    this.tempGeloReal = '';
                    this.tempGelo = null;
                    this.hasTempGelo = false;
                    this.showRangeError = false;
                }
            },
            
            init() {
                // Monitora mudanças no modelo da caixa
                const modeloSelect = document.querySelector('select[name="modelo_caixa"]');
                if (modeloSelect) {
                    modeloSelect.addEventListener('change', (e) => {
                        this.selectedModel = e.target.value;
                        this.hasModelo = !!e.target.value;
                    });
                    this.selectedModel = modeloSelect.value;
                    this.hasModelo = !!modeloSelect.value;
                }
                
                // Monitora número do pedido
                const numeroPedidoInput = document.querySelector('input[name="numero_pedido"]');
                if (numeroPedidoInput) {
                    numeroPedidoInput.addEventListener('input', (e) => {
                        this.hasPedido = !!e.target.value.trim();
                    });
                    this.hasPedido = !!numeroPedidoInput.value.trim();
                }
                
                // Monitora data da embalagem
                const dataEmbalagemInput = document.querySelector('input[name="data_embalagem"]');
                if (dataEmbalagemInput) {
                    dataEmbalagemInput.addEventListener('change', (e) => {
                        this.hasData = !!e.target.value;
                    });
                    this.hasData = !!dataEmbalagemInput.value;
                }
                
                // Monitora foto da etiqueta
                const fotoEtiquetaInput = document.querySelector('input[name="foto_etiqueta"]');
                if (fotoEtiquetaInput) {
                    fotoEtiquetaInput.addEventListener('change', (e) => {
                        this.hasFotoEtiqueta = e.target.files.length > 0;
                    });
                }
                
                // Monitora foto temperatura medicamento
                const fotoTempMedInput = document.querySelector('input[name="foto_temperatura_medicamento"]');
                if (fotoTempMedInput) {
                    fotoTempMedInput.addEventListener('change', (e) => {
                        this.hasFotoTempMed = e.target.files.length > 0;
                    });
                }
                
                // Monitora temperatura medicamento
                const tempMedInput = document.querySelector('input[name="temperatura_medicamento"]');
                if (tempMedInput) {
                    tempMedInput.addEventListener('input', (e) => {
                        this.tempMedicamento = parseFloat(e.target.value);
                        this.hasTempMed = !!e.target.value;
                    });
                    this.hasTempMed = !!tempMedInput.value;
                }
                
                // Monitora foto temperatura gelo
                const fotoTempGeloInput = document.querySelector('input[name="foto_temperatura_gelo"]');
                if (fotoTempGeloInput) {
                    fotoTempGeloInput.addEventListener('change', (e) => {
                        this.hasFotoTempGelo = e.target.files.length > 0;
                    });
                }
                
                // Temperatura do gelo agora é gerenciada pela função updateTempGelo() via Alpine.js
                
                // Preview de imagens
                this.setupImagePreview('foto_etiqueta', 'previewEtiqueta');
                this.setupImagePreview('foto_temperatura_medicamento', 'previewTempMedicamento');
                this.setupImagePreview('foto_temperatura_gelo', 'previewTempGelo');
            },
            
            get tempRangeMedicamento() {
                if (this.selectedModel === '33L_IF1050') {
                    return '15°C até 25°C';
                }
                return '2°C até 8°C';
            },
            
            get isValidTempMedicamento() {
                if (this.tempMedicamento === null || isNaN(this.tempMedicamento)) return true;
                
                if (this.selectedModel === '33L_IF1050') {
                    return this.tempMedicamento >= 15 && this.tempMedicamento <= 25;
                }
                return this.tempMedicamento >= 2 && this.tempMedicamento <= 8;
            },
            
            get isValidTempGelo() {
                if (this.tempGelo === null || isNaN(this.tempGelo)) return true;
                return this.tempGelo >= -9 && this.tempGelo <= -5;
            },
            
            get progressPercentage() {
                let completed = 0;
                const totalSteps = 6;
                
                // Passo 1: Modelo da caixa
                if (this.hasModelo) completed++;
                
                // Passo 2: Número do pedido
                if (this.hasPedido) completed++;
                
                // Passo 3: Data da embalagem
                if (this.hasData) completed++;
                
                // Passo 4: Foto da etiqueta
                if (this.hasFotoEtiqueta) completed++;
                
                // Passo 5: Foto e temperatura do medicamento
                if (this.hasFotoTempMed && this.hasTempMed) completed++;
                
                // Passo 6: Foto e temperatura do gelo
                if (this.hasFotoTempGelo && this.hasTempGelo) completed++;
                
                return Math.round((completed / totalSteps) * 100);
            },
            
            setupImagePreview(inputName, previewProperty) {
                const input = document.querySelector(`input[name="${inputName}"]`);
                if (input) {
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this[previewProperty] = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }
        };
    }
    
    // Validação adicional antes do envio
    document.getElementById('trocaGeloForm').addEventListener('submit', function(e) {
        const tempMed = parseFloat(document.querySelector('input[name="temperatura_medicamento"]').value);
        const tempGeloInput = document.querySelector('input[name="temperatura_gelo"]');
        const tempGelo = tempGeloInput ? parseFloat(tempGeloInput.value) : null;
        const modelo = document.querySelector('select[name="modelo_caixa"]').value;
        
        let valid = true;
        let message = '';
        
        // Valida temperatura do medicamento
        if (modelo === '33L_IF1050') {
            if (tempMed < 15 || tempMed > 25) {
                valid = false;
                message += 'Temperatura do medicamento deve estar entre 15°C e 25°C para caixa de 33L.\n';
            }
        } else {
            if (tempMed < 2 || tempMed > 8) {
                valid = false;
                message += 'Temperatura do medicamento deve estar entre 2°C e 8°C.\n';
            }
        }
        
        // Valida temperatura do gelo
        if (!tempGelo || isNaN(tempGelo)) {
            valid = false;
            message += 'Por favor, informe a temperatura do gelo.\n';
        } else if (tempGelo < -9 || tempGelo > -5) {
            valid = false;
            message += 'Temperatura do gelo deve estar entre -5,0°C e -9,0°C.\n';
            message += `Valor informado: ${tempGelo}°C\n`;
        }
        
        if (!valid) {
            e.preventDefault();
            alert('Atenção!\n\n' + message);
        }
    });
</script>
{% endblock %}
