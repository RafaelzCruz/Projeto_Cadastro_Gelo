{% extends 'base.html' %}

{% block title %}Formulário de Troca de Gelo - 5S{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="trocaGeloForm()">
    <!-- Card Principal -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <!-- Título -->
        <div class="mb-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <i class="fas fa-clipboard-check text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800">Formulário de Troca de Gelo</h2>
            <p class="text-gray-600 mt-2">Preencha todos os passos para registrar a troca</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Progresso</span>
                <span class="text-sm font-medium text-gray-700" x-text="progressPercentage + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" 
                     :style="'width: ' + progressPercentage + '%'"></div>
            </div>
        </div>

        <!-- Formulário -->
        <form method="post" enctype="multipart/form-data" id="trocaGeloForm">
            {% csrf_token %}

            <!-- Passo 01: Modelo da Caixa -->
            <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-full font-bold mr-3">
                        1
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Modelo da Caixa</h3>
                </div>
                
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">
                        {{ form.modelo_caixa.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.modelo_caixa }}
                    
                    <!-- Info dinâmica baseada no modelo -->
                    <div x-show="selectedModel" class="mt-3 p-4 bg-white rounded-lg border border-blue-200">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <strong>Faixa de temperatura do medicamento:</strong>
                            <span x-text="tempRangeMedicamento"></span>
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <i class="fas fa-snowflake text-blue-600 mr-2"></i>
                            <strong>Faixa de temperatura do gelo:</strong>
                            <span>-5,0°C até -9,0°C</span>
                        </p>
                    </div>
                    
                    {% if form.modelo_caixa.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.modelo_caixa.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 02: Número do Pedido -->
            <div class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-purple-600 text-white rounded-full font-bold mr-3">
                        2
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Número do Pedido</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.numero_pedido.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.numero_pedido }}
                    
                    {% if form.numero_pedido.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.numero_pedido.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 03: Data da Embalagem -->
            <div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl border-2 border-green-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full font-bold mr-3">
                        3
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Data da Embalagem</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.data_embalagem.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.data_embalagem }}
                    
                    {% if form.data_embalagem.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.data_embalagem.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 04: Foto da Etiqueta -->
            <div class="mb-8 p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border-2 border-yellow-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-yellow-600 text-white rounded-full font-bold mr-3">
                        4
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Foto da Etiqueta</h3>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.foto_etiqueta.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.foto_etiqueta }}
                    
                    <div x-show="previewEtiqueta" class="mt-4">
                        <img :src="previewEtiqueta" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                    </div>
                    
                    {% if form.foto_etiqueta.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {{ form.foto_etiqueta.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Passo 05: Temperatura do Medicamento -->
            <div class="mb-8 p-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border-2 border-red-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-red-600 text-white rounded-full font-bold mr-3">
                        5
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Temperatura do Medicamento</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Alerta de faixa de temperatura -->
                    <div class="p-4 bg-white rounded-lg border-2 border-red-300">
                        <p class="text-sm font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-thermometer-half text-red-600 mr-2"></i>
                            Faixa obrigatória:
                            <span class="ml-2 text-red-600" x-text="tempRangeMedicamento"></span>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.foto_temperatura_medicamento.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.foto_temperatura_medicamento }}
                        
                        <div x-show="previewTempMedicamento" class="mt-4">
                            <img :src="previewTempMedicamento" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                        </div>
                        
                        {% if form.foto_temperatura_medicamento.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.foto_temperatura_medicamento.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.temperatura_medicamento.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.temperatura_medicamento }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.temperatura_medicamento.help_text }}</p>
                        
                        <!-- Validação visual em tempo real -->
                        <div x-show="tempMedicamento !== null && tempMedicamento !== ''" class="mt-2">
                            <div x-show="isValidTempMedicamento" class="text-green-600 text-sm flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                Temperatura dentro da faixa permitida
                            </div>
                            <div x-show="!isValidTempMedicamento" class="text-red-600 text-sm flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Temperatura fora da faixa permitida!
                            </div>
                        </div>
                        
                        {% if form.temperatura_medicamento.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.temperatura_medicamento.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Passo 06: Temperatura do Gelo -->
            <div class="mb-8 p-6 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border-2 border-cyan-200">
                <div class="flex items-center mb-4">
                    <div class="flex items-center justify-center w-10 h-10 bg-cyan-600 text-white rounded-full font-bold mr-3">
                        6
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Temperatura do Gelo</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Alerta de faixa de temperatura -->
                    <div class="p-4 bg-white rounded-lg border-2 border-cyan-300">
                        <p class="text-sm font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-snowflake text-cyan-600 mr-2"></i>
                            Faixa obrigatória:
                            <span class="ml-2 text-cyan-600">-5,0°C até -9,0°C</span>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.foto_temperatura_gelo.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.foto_temperatura_gelo }}
                        
                        <div x-show="previewTempGelo" class="mt-4">
                            <img :src="previewTempGelo" class="image-preview rounded-lg border-2 border-gray-300 shadow-md">
                        </div>
                        
                        {% if form.foto_temperatura_gelo.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.foto_temperatura_gelo.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.temperatura_gelo.label }}
                            <span class="text-red-500">*</span>
                        </label>
                        {{ form.temperatura_gelo }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.temperatura_gelo.help_text }}</p>
                        
                        <!-- Validação visual em tempo real -->
                        <div x-show="tempGelo !== null && tempGelo !== ''" class="mt-2">
                            <div x-show="isValidTempGelo" class="text-green-600 text-sm flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                Temperatura dentro da faixa permitida
                            </div>
                            <div x-show="!isValidTempGelo" class="text-red-600 text-sm flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Temperatura fora da faixa permitida!
                            </div>
                        </div>
                        
                        {% if form.temperatura_gelo.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {{ form.temperatura_gelo.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Informação de Ambientação -->
            <div class="mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <div class="flex items-center mb-3">
                    <i class="fas fa-clock text-indigo-600 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Período de Ambientação</h3>
                </div>
                <p class="text-sm text-gray-700">
                    Ao finalizar a última foto do gelo, o sistema registrará automaticamente:
                </p>
                <ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">
                    <li>Horário de finalização: momento do envio</li>
                    <li>Início da ambientação: 20 minutos antes da finalização</li>
                </ul>
                <div class="mt-3 p-3 bg-white rounded-lg border border-indigo-300">
                    <p class="text-xs text-gray-600">
                        <strong>Exemplo:</strong> Se você finalizar às 17:59, o período de ambientação será registrado de 17:39 até 17:59
                    </p>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Finalizar e Registrar Troca
                </button>
                
                <button type="reset" 
                        class="flex-1 bg-gray-200 text-gray-700 font-semibold py-4 px-6 rounded-xl hover:bg-gray-300 transition duration-300 flex items-center justify-center"
                        onclick="return confirm('Tem certeza que deseja limpar o formulário?')">
                    <i class="fas fa-redo mr-2"></i>
                    Limpar Formulário
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function trocaGeloForm() {
        return {
            selectedModel: '',
            tempMedicamento: null,
            tempGelo: null,
            previewEtiqueta: null,
            previewTempMedicamento: null,
            previewTempGelo: null,
            
            init() {
                // Monitora mudanças no modelo da caixa
                const modeloSelect = document.querySelector('select[name="modelo_caixa"]');
                if (modeloSelect) {
                    modeloSelect.addEventListener('change', (e) => {
                        this.selectedModel = e.target.value;
                    });
                    this.selectedModel = modeloSelect.value;
                }
                
                // Monitora mudanças nas temperaturas
                const tempMedInput = document.querySelector('input[name="temperatura_medicamento"]');
                if (tempMedInput) {
                    tempMedInput.addEventListener('input', (e) => {
                        this.tempMedicamento = parseFloat(e.target.value);
                    });
                }
                
                const tempGeloInput = document.querySelector('input[name="temperatura_gelo"]');
                if (tempGeloInput) {
                    tempGeloInput.addEventListener('input', (e) => {
                        this.tempGelo = parseFloat(e.target.value);
                    });
                }
                
                // Preview de imagens
                this.setupImagePreview('foto_etiqueta', 'previewEtiqueta');
                this.setupImagePreview('foto_temperatura_medicamento', 'previewTempMedicamento');
                this.setupImagePreview('foto_temperatura_gelo', 'previewTempGelo');
            },
            
            get tempRangeMedicamento() {
                if (this.selectedModel === '33L_IF1050') {
                    return '15°C até 25°C';
                }
                return '2°C até 8°C';
            },
            
            get isValidTempMedicamento() {
                if (this.tempMedicamento === null || isNaN(this.tempMedicamento)) return true;
                
                if (this.selectedModel === '33L_IF1050') {
                    return this.tempMedicamento >= 15 && this.tempMedicamento <= 25;
                }
                return this.tempMedicamento >= 2 && this.tempMedicamento <= 8;
            },
            
            get isValidTempGelo() {
                if (this.tempGelo === null || isNaN(this.tempGelo)) return true;
                return this.tempGelo >= -9 && this.tempGelo <= -5;
            },
            
            get progressPercentage() {
                let completed = 0;
                const totalSteps = 6;
                
                // Verifica cada campo
                const modeloSelect = document.querySelector('select[name="modelo_caixa"]');
                if (modeloSelect && modeloSelect.value) completed++;
                
                const numeroPedido = document.querySelector('input[name="numero_pedido"]');
                if (numeroPedido && numeroPedido.value) completed++;
                
                const dataEmbalagem = document.querySelector('input[name="data_embalagem"]');
                if (dataEmbalagem && dataEmbalagem.value) completed++;
                
                const fotoEtiqueta = document.querySelector('input[name="foto_etiqueta"]');
                if (fotoEtiqueta && fotoEtiqueta.files.length > 0) completed++;
                
                const fotoTempMed = document.querySelector('input[name="foto_temperatura_medicamento"]');
                const tempMed = document.querySelector('input[name="temperatura_medicamento"]');
                if (fotoTempMed && fotoTempMed.files.length > 0 && tempMed && tempMed.value) completed++;
                
                const fotoTempGelo = document.querySelector('input[name="foto_temperatura_gelo"]');
                const tempGelo = document.querySelector('input[name="temperatura_gelo"]');
                if (fotoTempGelo && fotoTempGelo.files.length > 0 && tempGelo && tempGelo.value) completed++;
                
                return Math.round((completed / totalSteps) * 100);
            },
            
            setupImagePreview(inputName, previewProperty) {
                const input = document.querySelector(`input[name="${inputName}"]`);
                if (input) {
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this[previewProperty] = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }
        };
    }
    
    // Validação adicional antes do envio
    document.getElementById('trocaGeloForm').addEventListener('submit', function(e) {
        const tempMed = parseFloat(document.querySelector('input[name="temperatura_medicamento"]').value);
        const tempGelo = parseFloat(document.querySelector('input[name="temperatura_gelo"]').value);
        const modelo = document.querySelector('select[name="modelo_caixa"]').value;
        
        let valid = true;
        let message = '';
        
        // Valida temperatura do medicamento
        if (modelo === '33L_IF1050') {
            if (tempMed < 15 || tempMed > 25) {
                valid = false;
                message += 'Temperatura do medicamento deve estar entre 15°C e 25°C para caixa de 33L.\n';
            }
        } else {
            if (tempMed < 2 || tempMed > 8) {
                valid = false;
                message += 'Temperatura do medicamento deve estar entre 2°C e 8°C.\n';
            }
        }
        
        // Valida temperatura do gelo
        if (tempGelo < -9 || tempGelo > -5) {
            valid = false;
            message += 'Temperatura do gelo deve estar entre -5,0°C e -9,0°C.\n';
        }
        
        if (!valid) {
            e.preventDefault();
            alert('Atenção!\n\n' + message);
        }
    });
</script>
{% endblock %}